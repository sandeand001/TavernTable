<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TavernTable - Isometric D&D Grid</title>
  <meta name="description" content="An interactive isometric grid for tabletop RPG games with creature tokens and dice rolling">
  <link rel="stylesheet" href="src/ui/styles.css">
</head>
<body>
  <!-- Main Game Canvas Container -->
  <div id="game-container" aria-label="Game canvas for TavernTable grid"></div>
  
  <!-- 3D Dice Container -->
  <div id="dice-3d-container" aria-label="3D dice rolling area"></div>
  
  <!-- Dice Rolling Panel -->
  <div id="dice-panel" role="complementary" aria-label="Dice rolling controls">
    <div>🎲 Roll Dice:</div>
    <div class="dice-count-container">
      <label for="dice-count" class="dice-count-label">Count:</label>
      <input type="number" id="dice-count" min="1" max="10" value="1" aria-describedby="dice-help">
    </div>
    <button onclick="rollDice(4)" aria-label="Roll 4-sided die">d4</button>
    <button onclick="rollDice(6)" aria-label="Roll 6-sided die">d6</button>
    <button onclick="rollDice(8)" aria-label="Roll 8-sided die">d8</button>
    <button onclick="rollDice(10)" aria-label="Roll 10-sided die">d10</button>
    <button onclick="rollDice(12)" aria-label="Roll 12-sided die">d12</button>
    <button onclick="rollDice(20)" aria-label="Roll 20-sided die">d20</button>
    <div id="dice-result" aria-live="polite">Result: -</div>
    <div id="dice-help" class="sr-only">Select number of dice and click a die type to roll</div>
  </div>
  
  <!-- Token and Game Controls Panel -->
  <div id="token-panel" role="complementary" aria-label="Game controls and creature tokens">
    <!-- This panel will be moved to the right sidebar -->
  </div>

  <!-- Right Sidebar Menu System -->
  <div id="right-sidebar" role="complementary" aria-label="Game management sidebar">
    <!-- Tab Navigation -->
    <div id="sidebar-tabs" role="tablist" aria-label="Game menu tabs">
  <button class="tab-button active" data-tab="dice-log" role="tab" aria-selected="true" aria-controls="dice-log-panel">🎲 Dice Log</button>
  <button class="tab-button" data-tab="creatures" role="tab" aria-selected="false" aria-controls="creatures-panel">🗡️ Creatures</button>
      <button class="tab-button" data-tab="terrain" role="tab" aria-selected="false" aria-controls="terrain-panel">🏔️ Terrain</button>
      <button class="tab-button" data-tab="biomes" role="tab" aria-selected="false" aria-controls="biomes-panel">🌍 Biomes</button>
      <button class="tab-button" data-tab="settings" role="tab" aria-selected="false" aria-controls="settings-panel">⚙️ Settings</button>
    </div>

    <!-- Tab Content Panels -->
    <div id="sidebar-content">
      <!-- Dice Log Panel -->
      <div id="dice-log-panel" class="tab-panel active" role="tabpanel" aria-labelledby="dice-log-tab">
        <div class="panel-header">🎲 Dice Roll History</div>
        <div id="dice-log-content">
          <div class="dice-log-entry">Welcome! Roll some dice to see history here.</div>
        </div>
        <div class="panel-footer">
          <button onclick="clearDiceLog()" class="clear-button">Clear History</button>
        </div>
      </div>

      <!-- Creatures Panel -->
      <div id="creatures-panel" class="tab-panel" role="tabpanel" aria-labelledby="creatures-tab">
        <div class="panel-header">🗡️ Creature Management</div>
        
        <!-- Creature Token Selection -->
        <div class="section">
          <div class="section-title">Token Selection</div>
          <div id="creature-content" role="group" aria-label="Creature token selection">
            <!-- Only tokens with existing sprites -->
            <button id="token-beholder" onclick="selectToken('beholder')" aria-label="Select Beholder token">👁️ Beholder</button>
            <button id="token-defeated-doll" onclick="selectToken('defeated-doll')" aria-label="Select Defeated Doll token">� Defeated Doll</button>
            <button id="token-dragon" onclick="selectToken('dragon')" aria-label="Select Dragon token">🐉 Dragon</button>
            <button id="token-goblin" onclick="selectToken('goblin')" aria-label="Select Goblin token">🧌 Goblin</button>
            <button id="token-mindflayer" onclick="selectToken('mindflayer')" aria-label="Select Mind Flayer token">🦑 Mind Flayer</button>
            <button id="token-minotaur" onclick="selectToken('minotaur')" aria-label="Select Minotaur token">🐂 Minotaur</button>
            <button id="token-orc" onclick="selectToken('orc')" aria-label="Select Orc token">🧟 Orc</button>
            <button id="token-owlbear" onclick="selectToken('owlbear')" aria-label="Select Owlbear token">🐻 Owlbear</button>
            <button id="token-skeleton" onclick="selectToken('skeleton')" aria-label="Select Skeleton token">💀 Skeleton</button>
            <button id="token-troll" onclick="selectToken('troll')" aria-label="Select Troll token">🧟‍♂️ Troll</button>
          </div>
        </div>
        
        <!-- Token Actions -->
        <div class="section">
          <div class="section-title">Token Actions</div>
          <button id="token-remove" onclick="selectToken('remove')" class="action-button" aria-label="Select remove mode to delete tokens">🚫 Remove</button>
        </div>
        
        <!-- Facing Direction Controls -->
        <div class="section">
          <div class="section-title">Facing Direction</div>
          <button id="facing-right" onclick="toggleFacing()" class="action-button selected" aria-pressed="true" aria-label="Toggle token facing direction">➡️ Right</button>
        </div>

        <!-- Sprite Position Adjuster -->
        <div class="section">
          <div class="section-title">Sprite Adjust</div>
          <div class="nudge-grid">
            <button id="nudge-up" onclick="nudgeSelectedSprite(0,-1)" aria-label="Nudge sprite up">⬆️</button>
            <div class="nudge-middle-row">
              <button id="nudge-left" onclick="nudgeSelectedSprite(-1,0)" aria-label="Nudge sprite left">⬅️</button>
              <button id="nudge-center" onclick="captureSpriteBaseline()" aria-label="Capture current sprite baseline">🎯</button>
              <button id="nudge-right" onclick="nudgeSelectedSprite(1,0)" aria-label="Nudge sprite right">➡️</button>
            </div>
            <button id="nudge-down" onclick="nudgeSelectedSprite(0,1)" aria-label="Nudge sprite down">⬇️</button>
          </div>
          <div class="adjust-actions">
            <button id="save-offset" onclick="saveSpriteOffset()" aria-label="Save current sprite offset for this creature type">💾 Save Offset</button>
            <button id="toggle-auto-apply" onclick="toggleAutoApplyOffsets()" aria-label="Toggle auto apply saved offsets">⚡ Auto Apply: Off</button>
            <button id="reset-offset" onclick="resetSpriteOffset()" aria-label="Reset saved offset for this creature type">♻️ Reset Offset</button>
          </div>
          <div id="sprite-adjust-log" class="adjust-log" aria-live="polite"></div>
        </div>
      </div>

      <!-- Terrain Panel -->
      <div id="terrain-panel" class="tab-panel" role="tabpanel" aria-labelledby="terrain-tab">
        <div class="panel-header">🏔️ Terrain & Grid</div>
        
        <!-- Grid Configuration -->
        <div class="section">
          <div class="section-title">Grid Configuration</div>
          <div class="grid-controls-row">
            <label class="grid-label" for="grid-width">Width:</label>
            <input type="number" id="grid-width" min="5" max="50" value="25" class="grid-input" aria-describedby="grid-help">
            <label class="grid-label" for="grid-height">Height:</label>
            <input type="number" id="grid-height" min="5" max="50" value="25" class="grid-input" aria-describedby="grid-help">
          </div>
          <button onclick="resizeGrid()" class="action-button" aria-label="Apply new grid dimensions">🔄 Resize Grid</button>
          <button onclick="resetZoom()" class="action-button" aria-label="Reset zoom level to default">🔍 Reset Zoom</button>
        </div>
        
        <!-- Terrain Tools -->
        <div class="section">
          <div class="section-title">Terrain Tools</div>
          
          <!-- Terrain Mode Toggle -->
          <div class="terrain-mode">
            <label class="toggle-switch">
              <input type="checkbox" id="terrain-mode-toggle" onchange="toggleTerrainMode()">
              <span class="toggle-slider"></span>
              <span class="toggle-label">Terrain Mode</span>
            </label>
          </div>
          
          <!-- Terrain Tools -->
          <div id="terrain-tools" class="terrain-tools-container" style="display: none;">
            <div class="tool-group">
              <div class="section-subtitle">Tools</div>
              <div class="tool-buttons">
                <button id="terrain-raise-btn" onclick="setTerrainTool('raise')" class="terrain-tool-btn active" aria-label="Raise terrain height">⬆️ Raise</button>
                <button id="terrain-lower-btn" onclick="setTerrainTool('lower')" class="terrain-tool-btn" aria-label="Lower terrain height">⬇️ Lower</button>
              </div>
            </div>
            
            <div class="tool-group">
              <div class="section-subtitle">Brush Size</div>
              <div class="brush-controls">
                <button onclick="decreaseBrushSize()" class="brush-btn" aria-label="Decrease brush size">➖</button>
                <span id="brush-size-display" class="brush-size">1x1</span>
                <button onclick="increaseBrushSize()" class="brush-btn" aria-label="Increase brush size">➕</button>
              </div>
            </div>
            
            <div class="tool-group">
              <div class="section-subtitle">Height Indicator</div>
              <div class="height-indicator">
                <span class="height-label">Current Level:</span>
                <span id="terrain-height-display" class="height-value">0</span>
                <div class="height-scale" aria-label="Terrain height scale -10 to 10">
                  <span class="scale-mark" data-height="-10">-10</span>
                  <span class="scale-mark" data-height="-9">-9</span>
                  <span class="scale-mark" data-height="-8">-8</span>
                  <span class="scale-mark" data-height="-7">-7</span>
                  <span class="scale-mark" data-height="-6">-6</span>
                  <span class="scale-mark" data-height="-5">-5</span>
                  <span class="scale-mark" data-height="-4">-4</span>
                  <span class="scale-mark" data-height="-3">-3</span>
                  <span class="scale-mark" data-height="-2">-2</span>
                  <span class="scale-mark" data-height="-1">-1</span>
                  <span class="scale-mark current" data-height="0">0</span>
                  <span class="scale-mark" data-height="1">1</span>
                  <span class="scale-mark" data-height="2">2</span>
                  <span class="scale-mark" data-height="3">3</span>
                  <span class="scale-mark" data-height="4">4</span>
                  <span class="scale-mark" data-height="5">5</span>
                  <span class="scale-mark" data-height="6">6</span>
                  <span class="scale-mark" data-height="7">7</span>
                  <span class="scale-mark" data-height="8">8</span>
                  <span class="scale-mark" data-height="9">9</span>
                  <span class="scale-mark" data-height="10">10</span>
                </div>
              </div>
            </div>

            <div class="tool-group">
              <div class="section-subtitle">Elevation Perception</div>
              <div class="setting-item">
                <label for="elevation-scale-range">Pixels per level:</label>
                <input type="range" id="elevation-scale-range" min="0" max="20" step="1" value="8" class="range-input" aria-label="Adjust elevation visual scale">
                <span id="elevation-scale-value" class="range-value">8 px/level</span>
              </div>
              <small class="small-text">Adjusts how dramatic vertical differences appear; affects terrain overlays and token vertical placement.</small>
            </div>
            
            <div class="tool-group">
              <div class="section-subtitle">Actions</div>
              <button id="terrain-reset-btn" class="action-button terrain-reset" aria-label="Reset all terrain to default height">🔄 Reset Terrain</button>
            </div>

            <!-- Biome selection moved to dedicated Biomes tab (panel relocated outside terrain panel) -->
            
            <div class="tool-group">
              <div class="section-subtitle">Shortcuts</div>
              <div class="shortcuts-text">
                <small>• <strong>R</strong>: Raise tool</small><br>
                <small>• <strong>L</strong>: Lower tool</small><br>
                <small>• <strong>[ ]</strong>: Brush size</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Biomes Panel (sibling to terrain/settings panels) -->
      <div id="biomes-panel" class="tab-panel" role="tabpanel" aria-labelledby="biomes-tab">
        <div class="panel-header">🌍 Biomes</div>
        <div class="section">
          <div class="section-title">Select a Biome Palette</div>
          <div id="biome-menu-root" class="biome-menu" aria-label="Biome selection menu">
            <!-- Biome group buttons injected at runtime -->
          </div>
          <div class="section-subtitle" style="margin-top:1rem;">Notes</div>
          <p class="small-text">Biome palette applies to base grid outside of Terrain Edit mode. Enter Terrain mode to edit heights; exit to view biome coloring.</p>
        </div>
      </div>

      <!-- Settings Panel -->
      <div id="settings-panel" class="tab-panel" role="tabpanel" aria-labelledby="settings-tab">
        <div class="panel-header">⚙️ Game Settings</div>
        
        <div class="section">
          <div class="section-title">Display Options</div>
          <div class="setting-item">
            <label for="grid-opacity">Grid Opacity:</label>
            <input type="range" id="grid-opacity" min="0" max="100" value="50" class="range-input">
            <span class="range-value">50%</span>
          </div>
          <div class="setting-item">
            <label for="animation-speed">Animation Speed:</label>
            <input type="range" id="animation-speed" min="0.5" max="2" step="0.1" value="1" class="range-input">
            <span class="range-value">1x</span>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">Game Info</div>
          <div id="token-info" aria-live="polite">Click on grid to place selected token</div>
          
          <!-- Help Section -->
          <div class="help-section">
            <div class="section-title">🎮 Controls:</div>
            <div class="help-text">• <strong>Space + Drag</strong>: Pan grid</div>
            <div class="help-text">• <strong>Right-click + Drag Token</strong>: Move token</div>
            <div class="help-text">• <strong>Mouse Wheel</strong>: Zoom in/out</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Display Container (created by ErrorHandler) -->
  <div id="error-display" aria-live="assertive"></div>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.x/dist/pixi.min.js"></script>

  <!-- Global Function Safety Stubs - Prevent timing errors during module loading -->
  <script>
    // Create safety stub functions for HTML onclick handlers
    // These will be replaced by the actual implementations once modules load
    window.rollDice = function(sides) { 
      console.warn('Dice system not yet loaded, sides:', sides); 
      return null;
    };
    window.selectToken = function(tokenType) { 
      console.warn('Token system not yet loaded, tokenType:', tokenType); 
    };
    window.resizeGrid = function() { 
      console.warn('Grid system not yet loaded'); 
    };
    window.toggleCreatureTokens = function() {
      console.warn('UI system not yet loaded');
    };
    window.resetZoom = function() {
      console.warn('Zoom system not yet loaded');
    };
    
    // Track module loading progress
    window.moduleLoadStatus = {
      loaded: false,
      errors: []
    };
  </script>

  <!-- Core Configuration and Utilities (ES6) -->
  <script type="module" src="./src/config/GameConstants.js"></script>
  <script type="module" src="./src/config/BiomeConstants.js"></script>
  <script type="module" src="./src/utils/ErrorHandler.js"></script>
  <script type="module" src="./src/utils/Validation.js"></script>
  <script type="module" src="./src/utils/Logger.js"></script>
  <script type="module" src="./src/utils/CoordinateUtils.js"></script>

  <!-- Manager Classes (ES6) -->
  <script type="module" src="./src/config/SpriteOffsets.js"></script>
  <script type="module" src="./src/managers/TokenManager.js"></script>
  <script type="module" src="./src/managers/InteractionManager.js"></script>
  <script type="module" src="./src/managers/GridRenderer.js"></script>

  <!-- Core Game Modules (ES6) -->
  <script type="module" src="./src/core/SpriteManager.js"></script>
  <script type="module" src="./src/core/GameManager.js"></script>
  
  <!-- Creature System (ES6) -->
  <script type="module" src="./src/entities/creatures/CreatureToken.js"></script>
  <script type="module" src="./src/entities/creatures/CreatureFactory.js"></script>
  <script type="module" src="./src/entities/creatures/index.js"></script>
  
  <!-- Game Systems (ES6) -->
  <script type="module" src="./src/systems/DragController.js"></script>
  <script type="module" src="./src/systems/dice/dice.js"></script>
  
  <!-- Main Application Entry Point -->
  <script type="module" src="./src/ui/UIController.js"></script>
  <script type="module" src="./src/ui/SidebarController.js"></script>

  <style>
    /* Screen reader only class for accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</body>
</html>
